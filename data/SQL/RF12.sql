-- REQUERIMIENTO 12

-- SE CREA LAS SIGUIENTES VISTAS:

CREATE VIEW PRODUCTOSVENDIDOSXSEMANA AS(
    SELECT TO_NUMBER(to_char(to_date(FACTURA.FECHA,'DD/MM/YYYY'),'WW')) AS SEMANA, FACTURAPRODUCTO.IDPRODUCTO, SUM(FACTURAPRODUCTO.UNIVENDIDAS) AS SUMA
    FROM FACTURA
    INNER JOIN FACTURAPRODUCTO ON FACTURA.ID = FACTURAPRODUCTO.IDFACTURA
    GROUP BY TO_NUMBER(to_char(to_date(FACTURA.FECHA,'DD/MM/YYYY'),'WW')),FACTURAPRODUCTO.IDPRODUCTO
);

CREATE VIEW PEDIDOSPROVEEDORXSEMANA AS(
        SELECT TO_NUMBER(to_char(to_date(ORDEN.FECHAESPERADAENTREGA,'DD/MM/YYYY'),'WW')) AS SEMANA, IDPROVEEDOR, COUNT(IDPROVEEDOR) AS NUM_PEDIDOS
        FROM ORDEN
        GROUP BY TO_NUMBER(to_char(to_date(ORDEN.FECHAESPERADAENTREGA,'DD/MM/YYYY'),'WW')), IDPROVEEDOR);

-- PRODUCTO MAS VENDIDO EN CADA SEMANA DEL Aﾃ前
SELECT PRODUCTOSVENDIDOSXSEMANA.SEMANA, PRODUCTOSVENDIDOSXSEMANA.IDPRODUCTO, PRODUCTO.NOMBRE, SUBQUERY.MAXIMO
FROM
(SELECT SEMANA, MAX(SUMA) AS MAXIMO
FROM PRODUCTOSVENDIDOSXSEMANA
GROUP BY SEMANA) SUBQUERY
INNER JOIN PRODUCTOSVENDIDOSXSEMANA ON PRODUCTOSVENDIDOSXSEMANA.SUMA = SUBQUERY.MAXIMO AND PRODUCTOSVENDIDOSXSEMANA.SEMANA = SUBQUERY.SEMANA
INNER JOIN PRODUCTO ON PRODUCTO.ID = PRODUCTOSVENDIDOSXSEMANA.IDPRODUCTO
ORDER BY PRODUCTOSVENDIDOSXSEMANA.SEMANA;

-- PRODUCTO MENOS VENDIDO EN CADA SEMANA DEL Aﾃ前
SELECT PRODUCTOSVENDIDOSXSEMANA.SEMANA, PRODUCTOSVENDIDOSXSEMANA.IDPRODUCTO, PRODUCTO.NOMBRE, SUBQUERY.MINIMO
FROM
(SELECT SEMANA, MIN(SUMA) AS MINIMO
FROM PRODUCTOSVENDIDOSXSEMANA
GROUP BY SEMANA) SUBQUERY
INNER JOIN PRODUCTOSVENDIDOSXSEMANA ON PRODUCTOSVENDIDOSXSEMANA.SUMA = SUBQUERY.MINIMO AND PRODUCTOSVENDIDOSXSEMANA.SEMANA = SUBQUERY.SEMANA
INNER JOIN PRODUCTO ON PRODUCTO.ID = PRODUCTOSVENDIDOSXSEMANA.IDPRODUCTO
ORDER BY PRODUCTOSVENDIDOSXSEMANA.SEMANA;

-- PROVEEDOR MAS SOLICITADO EN CADA SEMANA DEL Aﾃ前
SELECT PEDIDOSPROVEEDORXSEMANA.SEMANA, PEDIDOSPROVEEDORXSEMANA.IDPROVEEDOR , PROVEEDOR.NOMBRE, PEDIDOSPROVEEDORXSEMANA.NUM_PEDIDOS
FROM
    (SELECT SEMANA, MAX(NUM_PEDIDOS) AS NUM_PEDIDOS
        FROM PEDIDOSPROVEEDORXSEMANA
        GROUP BY SEMANA, IDPROVEEDOR) SUBQUERY
INNER JOIN PEDIDOSPROVEEDORXSEMANA ON PEDIDOSPROVEEDORXSEMANA.SEMANA = SUBQUERY.SEMANA AND PEDIDOSPROVEEDORXSEMANA.NUM_PEDIDOS = SUBQUERY.NUM_PEDIDOS
INNER JOIN PROVEEDOR ON PROVEEDOR.ID = PEDIDOSPROVEEDORXSEMANA.IDPROVEEDOR;

-- PROVEEDOR MENOS SOLICITADO EN CADA SEMANA DEL Aﾃ前
SELECT PEDIDOSPROVEEDORXSEMANA.SEMANA, PEDIDOSPROVEEDORXSEMANA.IDPROVEEDOR , PROVEEDOR.NOMBRE, PEDIDOSPROVEEDORXSEMANA.NUM_PEDIDOS
FROM
    (SELECT SEMANA, MIN(NUM_PEDIDOS) AS NUM_PEDIDOS
        FROM PEDIDOSPROVEEDORXSEMANA
        GROUP BY SEMANA, IDPROVEEDOR) SUBQUERY
INNER JOIN PEDIDOSPROVEEDORXSEMANA ON PEDIDOSPROVEEDORXSEMANA.SEMANA = SUBQUERY.SEMANA AND PEDIDOSPROVEEDORXSEMANA.NUM_PEDIDOS = SUBQUERY.NUM_PEDIDOS
INNER JOIN PROVEEDOR ON PROVEEDOR.ID = PEDIDOSPROVEEDORXSEMANA.IDPROVEEDOR;